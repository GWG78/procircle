<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ProCircle Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Shopify App Bridge v3 -->
  <script src="https://unpkg.com/@shopify/app-bridge@3"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "San Francisco", "Helvetica Neue", sans-serif;
      background: #f6f6f7;
    }

    .App {
      min-height: 100vh;
      padding: 24px;
      display: flex;
      justify-content: center;
    }

    .Card {
      background: #fff;
      border-radius: 12px;
      padding: 24px;
      width: 100%;
      max-width: 960px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    .Title { font-size: 20px; font-weight: 600; margin-bottom: 4px; }
    .Subtitle { color: #6d7175; margin-bottom: 20px; }
  </style>
</head>

<body>
  <div class="App">
    <div class="Card">
      <h1 class="Title">ProCircle settings</h1>
      <p class="Subtitle">Control who can claim discounts and how codes are generated.</p>

      <p>If you can see this, the app UI is loading correctly.</p>
    </div>
  </div>

  <!-- API KEY injected by server -->
  <script id="procircle-env" data-api-key=""></script>

  <script>
    (function () {
      const apiKey = document.getElementById("procircle-env")?.dataset.apiKey;
      const params = new URLSearchParams(window.location.search);
      const shop = params.get("shop");
      const host = params.get("host");

      if (!shop || !host) return;

      const AppBridge = window["app-bridge"];

      if (!apiKey || !shop || !host) {
        document.body.innerHTML = `
          <h2>Missing required App Bridge params</h2>
          <pre>
      apiKey: ${apiKey}
      shop: ${shop}
      host: ${host}
          </pre>
        `;
        throw new Error("Missing apiKey, shop, or host");
      }

      const createApp = AppBridge.createApp;
      const Redirect = AppBridge.actions.Redirect;

      const app = createApp({
        apiKey,
        host,
        forceRedirect: true,
      });

      fetch(`/auth?shop=${shop}`, { credentials: "include" })
        .then(async (res) => {
          if (res.status === 401) {
            const data = await res.json();
            if (data?.redirectUrl) {
              Redirect.create(app).dispatch(
                Redirect.Action.REMOTE,
                data.redirectUrl
              );
            }
          }
        })
        .catch(() => {});
    })();
</script>

  <script>
    (function () {
      const apiKey = document.getElementById("procircle-env")?.dataset.apiKey;

      const params = new URLSearchParams(window.location.search);
      const shop = params.get("shop");
      const host = params.get("host");

      if (!apiKey || !shop || !host) {
        console.error("Missing apiKey, shop, or host");
        return;
      }

      const AppBridge = window["app-bridge"];
      const createApp = AppBridge.createApp;
      const Redirect = AppBridge.actions.Redirect;

      const app = createApp({
        apiKey,
        host,
        forceRedirect: true,
      });

      const redirect = Redirect.create(app);

      // üîê Trigger OAuth ONLY if backend says not installed
      if (window.__PROCIRCLE_INSTALLED__ === false) {
        redirect.dispatch(
          Redirect.Action.REMOTE,
          `/auth?shop=${shop}&host=${host}`
        );
        return;
      }

      // Otherwise, app is installed ‚Üí normal UI continues
      console.log("‚úÖ App installed, dashboard ready");
    })();
  </script>
</body>
</html>